### 1. 允许容器访问外部网络

bash

```
# 允许从 Docker 容器网络到外部的转发
sudo iptables -I FORWARD -s 172.18.0.0/24 -j ACCEPT
sudo iptables -I FORWARD -d 172.18.0.0/24 -j ACCEPT

# 允许已建立的连接和相关的连接
sudo iptables -I FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
```



### 2. 确保 POSTROUTING 规则正确

您已经有一条 MASQUERADE 规则，这很好，它使得容器可以访问外部网络时进行源地址转换（SNAT）。您的 nat 表中已经有：

text

```
Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
MASQUERADE  all  --  172.18.0.0/16        0.0.0.0/0           
MASQUERADE  all  --  172.17.0.0/16        0.0.0.0/0
```



这条规则允许 172.18.0.0/16（包含了您的 172.18.0.0/24）和 172.17.0.0/16 的网络进行 MASQUERADE。

### 3. 检查并确保 UFW 允许转发

UFW 默认会阻止转发流量，您需要允许 Docker 网络的转发。您可以编辑 UFW 的配置文件：

bash

```
sudo nano /etc/ufw/after.rules
```



在文件末尾添加以下规则（在 commit 之前）：

text

```
# Docker 网络转发
-A ufw-before-forward -s 172.18.0.0/24 -j ACCEPT
-A ufw-before-forward -d 172.18.0.0/24 -j ACCEPT
```



然后重启 UFW：

bash

```
sudo systemctl restart ufw
```