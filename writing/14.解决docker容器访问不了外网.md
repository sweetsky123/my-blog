### 1. 允许容器访问外部网络

bash

```
# 允许从 Docker 容器网络到外部的转发
sudo iptables -I FORWARD -s 172.18.0.0/24 -j ACCEPT
sudo iptables -I FORWARD -d 172.18.0.0/24 -j ACCEPT

# 允许已建立的连接和相关的连接
sudo iptables -I FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
```



### 2. 确保 POSTROUTING 规则正确

您已经有一条 MASQUERADE 规则，这很好，它使得容器可以访问外部网络时进行源地址转换（SNAT）。您的 nat 表中已经有：

text

```
Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
MASQUERADE  all  --  172.18.0.0/16        0.0.0.0/0           
MASQUERADE  all  --  172.17.0.0/16        0.0.0.0/0
```



这条规则允许 172.18.0.0/16（包含了您的 172.18.0.0/24）和 172.17.0.0/16 的网络进行 MASQUERADE。

### 3. 检查并确保 UFW 允许转发

UFW 默认会阻止转发流量，您需要允许 Docker 网络的转发。您可以编辑 UFW 的配置文件：

bash

```
sudo nano /etc/ufw/after.rules
```



在文件末尾添加以下规则（在 commit 之前）：

text

```
# Docker 网络转发
-A ufw-before-forward -s 172.18.0.0/24 -j ACCEPT
-A ufw-before-forward -d 172.18.0.0/24 -j ACCEPT
```



然后重启 UFW：

bash

```
sudo systemctl restart ufw
```



## 删除规则

1. **首先，列出 FORWARD 链的所有规则并显示编号：**

   bash

   ```
   sudo iptables -L FORWARD --line-numbers
   ```

   

2. **查看输出，找到您要删除的规则对应的编号。**
   输出结果会像这样：

   text

   ```
   Chain FORWARD (policy DROP)
   num  target     prot opt source               destination
   1    ACCEPT     all  --  172.18.2.0/24        anywhere
   2    ACCEPT     all  --  anywhere             172.18.2.0/24
   3    ACCEPT     all  --  anywhere             anywhere             ctstate RELATED,ESTABLISHED
   ...
   ```

   

   从上面可以看出，规则 `1` 和 `2` 就是您刚才添加的。

3. **根据编号删除规则。**
   `-D` 的另一种用法是指定链名和编号。

   bash

   ```
   sudo iptables -D FORWARD 1
   sudo iptables -D FORWARD 1
   ```

   

   **注意**：删除第一条规则（编号1）后，原来编号为2的规则会变成新的编号1。所以第二次删除时仍然删除编号1即可。

------

### 验证删除结果

执行删除命令后，强烈建议您再次运行查看命令，确认规则已经不存在了：

bash

```
sudo iptables -L FORWARD
```



### 总结

对于您的情况，**最简单直接的方法就是执行方法一中的两条命令**：

bash

```
sudo iptables -D FORWARD -s 172.18.2.0/24 -j ACCEPT
sudo iptables -D FORWARD -d 172.18.2.0/24 -j ACCEPT
```



这样就完成了规则的清理。